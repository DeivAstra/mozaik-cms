CREATE DATABASE `${schema}`;
USE `${schema}`;

<#noparse>

CREATE TABLE `$_resource_sets` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `type` varchar(12) COLLATE latin1_bin NOT NULL,
  `title` varchar(100) COLLATE latin1_bin NOT NULL,
  `alias` varchar(100) COLLATE latin1_bin DEFAULT NULL,
  `descr` varchar(255) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=43 DEFAULT CHARSET=latin1 COLLATE=latin1_bin;

INSERT INTO `$_resource_sets` VALUES (38,'WIDGET','Wcm Widget','wcmwidget',NULL);
INSERT INTO `$_resource_sets` VALUES (39,'THEME','Default',NULL,NULL);
INSERT INTO `$_resource_sets` VALUES (40,'SKIN','Default',NULL,NULL);

CREATE TABLE `$_resources` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `resource_set_id` int(10) unsigned NOT NULL,
  `parent_id` int(10) unsigned DEFAULT NULL,
  `type` varchar(10) NOT NULL,
  `name` varchar(45) CHARACTER SET latin1 COLLATE latin1_general_ci NOT NULL,
  `source_data` blob,
  `compiled_data` blob,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_UNIQUE` (`id`),
  KEY `type` (`type`)
) ENGINE=InnoDB AUTO_INCREMENT=383 DEFAULT CHARSET=utf8;

INSERT INTO $_resources VALUES (331,38,NULL,'FOLDER','style',NULL,NULL);
INSERT INTO $_resources VALUES (332,38,NULL,'FOLDER','script',NULL,NULL);
INSERT INTO $_resources VALUES (333,38,NULL,'FOLDER','media',NULL,NULL);
INSERT INTO $_resources VALUES (334,38,NULL,'FOLDER','java',NULL,NULL);
INSERT INTO $_resources VALUES (335,38,NULL,'FOLDER','zul',NULL,NULL);
INSERT INTO $_resources VALUES (336,38,335,'ZUL','index.zul','<zk>\n	<!--\n	${execution.attributes}\n	-->\n	<div apply=\"org.zkoss.bind.BindComposer\" width=\"100%\" height=\"100%\"\n		viewModel=\"@id(\'vm\') @init(\'com.ktrsys.base.widget.wcmwidget.ComponentController\')\">\n	</div>\n</zk>',NULL);
INSERT INTO $_resources VALUES (337,38,335,'ZUL','layout_params.form.zul','<zk>\n	<idspace>\n	<zscript>\n	<![CDATA[\n		import com.ktrsys.mozaik.frnd.plus.callback.*;\n		import com.ktrsys.mozaik.frnd.admin.*;\n		import com.ktrsys.mozaik.bknd.api.*;\n		import com.ktrsys.mozaik.bknd.api.model.*;\n		import com.ktrsys.mozaik.bknd.api.service.*;\n		\n		WcmComponentService componentService = ServicesFacade.$().getWcmComponentService();\n		WcmDocumentService documentService = ServicesFacade.$().getWcmDocumentService();\n		WcmDocumentFolderService documentFolderService = ServicesFacade.$().getWcmDocumentFolderService();\n\n		WcmComponent component = null;\n		Object/*WcmDocument | WcmDocumentFolder*/ documentOrFolder = null;\n		\n		I_CallbackMap formCallback = FORM_CALLBACK;\n	]]>\n	</zscript>\n	<vlayout style=\"padding:20px\">\n		<hlayout>\n			<label class=\"form-label\" value=\"Component:\"/>\n			<label class=\"form-label\" id=\"selectedComponentInfoLabel\" width=\"300px\">\n				<attribute name=\"onCreate\">\n				<![CDATA[\n					Integer componentId;\n					try {\n						componentId = Integer.parseInt(LAYOUT_WIDGET_PARAMS.get(\"COMPONENT_ID\"));\n					} catch(Exception e){return;}\n					\n					component = componentService.read1(new WcmComponent().setId(componentId));\n					\n					if(component == null) {\n						self.setValue(\"Component with ID = \" + componentId + \" not found\");\n						self.setStyle(\"font-weight:bold;color:red\");\n					} else {\n						self.setValue(component.getTitle());\n					}\n				]]>\n				</attribute>\n			</label>\n			<button label=\"...\">\n				<attribute name=\"onClick\">\n				<![CDATA[\n					I_CallbackArg callback = new I_CallbackArg(){\n						public void call(WcmComponent c) {\n							component = c;\n							selectedComponentInfoLabel.setValue(c.getTitle());\n						}\n					};\n\n					Dialogs.selectComponent(callback);\n				]]>\n				</attribute>\n			</button>\n		</hlayout>\n		<hlayout>\n			<label class=\"form-label\" value=\"Document/Folder:\"/>\n			<label class=\"form-label\" id=\"selectedDocumentInfoLabel\" width=\"300px\">\n				<attribute name=\"onCreate\">\n				<![CDATA[\n					Integer elementId;\n					try {\n						elementId = Integer.parseInt(LAYOUT_WIDGET_PARAMS.get(\"ELEMENT_ID\"));\n					} catch(Exception e){return;}\n					\n					if(elementId < 0) {\n						documentOrFolder = documentFolderService.read1(new WcmDocumentFolder().setId(-elementId));\n					} else {\n						documentOrFolder = documentService.read1(new WcmDocument().setId(elementId));\n					}\n					\n					if(documentOrFolder == null) {\n						self.setValue(\"Document/Folder with ID = \" + elementId + \" not found\");\n						self.setStyle(\"font-weight:bold;color:red\");\n					} else {\n						self.setValue(documentOrFolder.getTitle());\n					}\n				]]>\n				</attribute>\n			</label>\n			<button label=\"...\">\n				<attribute name=\"onClick\">\n				<![CDATA[\n					I_CallbackArg callback = new I_CallbackArg(){\n						public void call(Object element) {\n							documentOrFolder = element; \n							selectedDocumentInfoLabel.setValue(element.getTitle());\n							selectedDocumentInfoLabel.setStyle(\"font-weight:initial;color:initial\");\n						}\n					};\n\n					Dialogs.selectDocumentOrFolder(callback);\n				]]>\n				</attribute>\n			</button>\n		</hlayout>\n		<hlayout>\n		 	<button label=\"Ok\">\n				<attribute name=\"onClick\">\n				<![CDATA[\n					//System.out.println(callback);\n					Map params = new HashMap();\n					if(component != null) {\n						params.put(\"COMPONENT_ID\", component.getId());\n					}\n					if(documentOrFolder instanceof WcmDocument) {\n						params.put(\"ELEMENT_ID\", documentOrFolder.getId());\n					} else if(documentOrFolder instanceof WcmDocumentFolder) {\n						params.put(\"ELEMENT_ID\", -documentOrFolder.getId());\n					}\n					formCallback.call(params);\n				]]>\n				</attribute>\n			</button>\n		</hlayout>\n	</vlayout>\n	</idspace>\n</zk>',NULL);
INSERT INTO $_resources VALUES (338,39,NULL,'FOLDER','style',NULL,NULL);
INSERT INTO $_resources VALUES (339,39,NULL,'FOLDER','script',NULL,NULL);
INSERT INTO $_resources VALUES (340,39,NULL,'FOLDER','media',NULL,NULL);
INSERT INTO $_resources VALUES (341,39,NULL,'FOLDER','java',NULL,NULL);
INSERT INTO $_resources VALUES (342,39,NULL,'FOLDER','zul',NULL,NULL);
INSERT INTO $_resources VALUES (343,39,342,'ZUL','index.zul','<?page title=\"${SITE.title} - ${PAGE.title}\"?>\n<html xmlns=\"native\">\n	<style src=\"theme.style\" xmlns=\"zul\"/>\n	<body>\n		<div class=\"theme-body\" xmlns=\"zul\">\n			<include src=\"header.zul\"/>\n			<page-layout/>\n			<include src=\"footer.zul\"/>\n		</div>\n	</body>\n</html>',NULL);
INSERT INTO $_resources VALUES (344,39,342,'ZUL','header.zul','<zk>\n	Header	\n</zk>',NULL);
INSERT INTO $_resources VALUES (345,39,342,'ZUL','footer.zul','<zk>\n	Footer\n</zk>',NULL);
INSERT INTO $_resources VALUES (346,39,338,'STYLE','theme.style','/* LESS */\n\nbody{\nbackground:silver;\n}\n/*\n.z-include{\nwidth:auto !important;\n}\n*/\n.theme-body{\nmax-width:1000px;\nmargin:0 auto;\nvisibility:visible !important;\n}\ntable.layout {\nborder-spacing:0;\nwidth:100%;\n}\ntable.layout>tbody>tr>td {\npadding:0;\nvertical-align:top;\noverflow:auto;\n}\n',NULL);
INSERT INTO $_resources VALUES (347,38,334,'JAVA','ComponentController.java','package com.ktrsys.base.widget.wcmwidget;\n\nimport org.zkoss.bind.annotation.*;\nimport org.zkoss.zk.ui.Executions;\nimport org.zkoss.zul.*;\nimport java.util.*;\n\nimport com.ktrsys.mozaik.frnd.common.controller.*;\nimport com.ktrsys.mozaik.bknd.api.*;\nimport com.ktrsys.mozaik.bknd.api.service.*;\nimport com.ktrsys.mozaik.bknd.api.model.*;\nimport com.ktrsys.mozaik.frnd.plus.zk.controller.MVVMController;\n\npublic class ComponentController extends MVVMController {\n	\n	private static final String LAYOUT_WIDGET_PARAMS_ATTR = \"LAYOUT_WIDGET_PARAMS\";\n	private static final String COMPONENT_ID_ATTR = \"COMPONENT_ID\";\n	private static final String ELEMENT_ID_ATTR = \"ELEMENT_ID\";\n	private static final String ELEMENT_ATTR = \"ELEMENT\";\n	private static final String API_ATTR = \"API\";\n	\n	private final WcmComponentService componentService = ServicesFacade.$().getWcmComponentService();\n	private final WcmDocumentService documentService = ServicesFacade.$().getWcmDocumentService();\n	private final WcmDocumentFolderService documentFolderService = ServicesFacade.$().getWcmDocumentFolderService();\n	\n	@AfterCompose(superclass=true)\n	public void doAfterCompose() {\n		final Map<String,String> widgetParams = (Map) Executions.getCurrent().getAttribute(LAYOUT_WIDGET_PARAMS_ATTR);\n		try	{\n			\n			if(widgetParams == null)\n				throw new Exception(LAYOUT_WIDGET_PARAMS_ATTR + \" not defined\");\n			\n			if(widgetParams.get(COMPONENT_ID_ATTR) == null)\n				throw new Exception(COMPONENT_ID_ATTR + \" not defined\");\n		\n			final int componentId = Integer.parseInt((String)widgetParams.get(COMPONENT_ID_ATTR));\n			final WcmComponent wcmComponent = componentService.read1(\n				new WcmComponent().setId(componentId)\n			);\n			if(wcmComponent == null)\n				throw new Exception(\"Component with ID = \" + componentId  + \" not found\");\n			\n			// override elementId from layout widget params if exists\n			final String elementParam = widgetParams.get(ELEMENT_ID_ATTR);\n			if(elementParam != null) {\n				wcmComponent.setElementId(Integer.parseInt(elementParam));\n			}\n			\n			if(wcmComponent.getElementId() == null)\n				throw new Exception(ELEMENT_ID_ATTR  + \" not defined\");\n			\n			Object element = null;\n			if(wcmComponent.getElementId() < 0) {\n				element = documentFolderService.read1(new WcmDocumentFolder().setId(-wcmComponent.getElementId()));\n			} else {\n				element = documentService.read1(new WcmDocument().setId(wcmComponent.getElementId()));\n			}\n			\n			System.out.println(\"element = \"+element);\n			\n			if(element == null) {\n				throw new Exception(\"Element with ID = \" + wcmComponent.getElementId()  + \" not found\");\n			}\n			\n			Executions.getCurrent().setAttribute(ELEMENT_ATTR, element);\n			Executions.getCurrent().setAttribute(API_ATTR, API.$());\n			getView().appendChild(Executions.createComponentsDirectly(\"<zk>\"+wcmComponent.getData()+\"</zk>\", \"zul\", null, null));\n		} catch(NumberFormatException e) {\n			showError(\"Error occured while parse \" + COMPONENT_ID_ATTR);\n		} catch(Throwable t) {\n			t.printStackTrace();\n			showError(t.getMessage()==null?t.getClass().getSimpleName():t.getMessage());\n		}\n	}\n	\n	private void showError(String message) {\n		final Label label = new Label(message);\n		label.setStyle(\"font-weight:bold;color:red\");\n		getView().appendChild(label);\n	}\n\n}',NULL);
INSERT INTO $_resources VALUES (348,40,NULL,'FOLDER','style',NULL,NULL);
INSERT INTO $_resources VALUES (349,40,NULL,'FOLDER','script',NULL,NULL);
INSERT INTO $_resources VALUES (350,40,NULL,'FOLDER','media',NULL,NULL);
INSERT INTO $_resources VALUES (351,40,NULL,'FOLDER','java',NULL,NULL);
INSERT INTO $_resources VALUES (352,40,NULL,'FOLDER','zul',NULL,NULL);
INSERT INTO $_resources VALUES (356,40,348,'STYLE','skin.style','/* LESS */\n\n.default-skin {\nbackground:purple;\nborder-top-left-radius:5px;\nborder-top-right-radius:5px;\npadding:2px;\n}\n.default-skin .title-area{\npadding:10px;\ncolor:white;\n}\n.default-skin .title-area div{\ndisplay:inline;\n}\n.default-skin .title-area div.right{\nfloat:right;\ncursor:pointer;\n}\n.default-skin .widget-body{\nbackground:white;\npadding:5px;\n}',NULL);
INSERT INTO $_resources VALUES (364,40,352,'ZUL','index.zul','<div class=\"default-skin\" xmlns=\"native\">\n	<style src=\"skin.style\" xmlns=\"zul\"/>\n	<header class=\"title-area\">\n		<div class=\"left\">\n			<span if=\"${!empty LAYOUT_SKIN_PARAMS.TITLE}\">${LAYOUT_SKIN_PARAMS.TITLE}</span>\n			<span if=\"${empty LAYOUT_SKIN_PARAMS.TITLE}\">${INCLUDED_RESOURCE_SET.title}</span>\n		</div>\n		<div class=\"right\">\n			<label if=\"${!empty LAYOUT_SKIN_PARAMS.COLLAPSIBLE}\"\n				   xmlns=\"zul\" value=\"=\" onClick=\"widgetBodyDiv.setVisible(!widgetBodyDiv.isVisible())\"/>\n		</div>\n	</header>\n	<div id=\"widgetBodyDiv\" class=\"widget-body\" xmlns=\"zul\">\n		<widget/>\n	</div>\n</div>',NULL);
INSERT INTO $_resources VALUES (365,40,352,'ZUL','layout_params.form.zul','<zk>\n	<idspace>\n	<zscript>\n	<![CDATA[\n		import com.ktrsys.mozaik.plus.*;\n		import com.ktrsys.mozaik.bknd.api.*;\n		import com.ktrsys.mozaik.bknd.api.model.*;\n		import com.ktrsys.mozaik.bknd.api.service.*;\n\n		WcmComponent component = null;\n		Object/*WcmDocument | WcmDocumentFolder*/ documentOrFolder = null;\n		\n		I_CallbackMap formCallback = FORM_CALLBACK;\n	]]>\n	</zscript>\n	<vlayout style=\"padding:20px\">\n		<hlayout>\n			<label class=\"form-label\" value=\"Title:\"/>\n			<textbox id=\"titleTextbox\" value=\"${LAYOUT_SKIN_PARAMS.get(\'TITLE\')}\" width=\"300px\"/>\n		</hlayout>\n		<hlayout>\n			<label class=\"form-label\" value=\"Collapsible:\"/>\n			<checkbox id=\"collapsibleCheckbox\" checked=\"${LAYOUT_SKIN_PARAMS.get(\'COLLAPSIBLE\')}\"/>\n		</hlayout>\n		<hlayout>\n		 	<button label=\"Ok\">\n				<attribute name=\"onClick\">\n				<![CDATA[\n					//System.out.println(callback);\n					Map params = new HashMap();\n					if(titleTextbox.getValue().trim().length() > 0) {\n						params.put(\"TITLE\", titleTextbox.getValue());\n					}\n					if(collapsibleCheckbox.isChecked()) {\n						params.put(\"COLLAPSIBLE\", Boolean.TRUE);\n					}\n					formCallback.call(params);\n				]]>\n				</attribute>\n			</button>\n		</hlayout>\n	</vlayout>\n	</idspace>\n</zk>',NULL);

</#noparse>
